{{~#output fileName=(x-concat model.name ".gen.cs") ~}}
childs[?name=='CSharp'].attrs | [0].merge(@, {
    OutputFolder: (OutputFolder||'Resources'),
    EncodingWithBOM: (EncodingWithBOM||'false')=='true',
    LineEndings: (LineEndings||'LF'),
    Enabled: (Enabled||'true')=='true',
    UseExpressionBodySyntax: (UseExpressionBodySyntax||'false')=='true',
    MissingTranslationFallbackToPrimary: (MissingTranslationFallbackToPrimary||'false')=='true',
    GenerateParamsMethods: (GenerateParamsMethods||'false')=='true',
    ParamsMethodsSuffix: (ParamsMethodsSuffix||'WithParams')
})
{{~/output~}}

{{! for each language generate resx file }}
{{~#each model.languages ~}}
    {{output-child templateId="NetResx" host=(x-value query="{lang: @}")}}
{{~/each~}}

{{! write extra file 'BindableObject.gen.cs' }}
{{~#output-inline fileName="BindableObject.gen.cs" ~}}
{{{ x-header }}}

namespace {{ @root.host.namespace }}
{
	using System.ComponentModel;
	using System.Runtime.CompilerServices;

	public abstract class BindableObject : INotifyPropertyChanged
	{
		public event PropertyChangedEventHandler PropertyChanged;
	
		protected virtual void OnPropertyChanged([CallerMemberName] string propertyName = null)
		{
			PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
		}

		public void RefreshProperties()
		{
			OnPropertyChanged(null);
		}
	}
}
{{/output-inline~}}

{{~m-data (x-concat model.name "Context") key="rootClassName" ~}}
{{~m-data (x-concat model.name "Keys") key="keysClassName" ~}}
{{~m-data (x-normalizePath @root.settings.OutputFolder replacePathSep=".") key="outputFolderDots" ~}}
{{~m-data (x-concat @root.host.namespace @root.data.outputFolderDots model.name sep=".") key="resourceTypeName" ~}}
{{~m-data (x-concat @root.host.namespace model.name sep=".") key="resourceType" ~}}
{{~m-data (x-concat @root.host.namespace ".BindableObject") key="bindableObjectFullName" ~}}
{{~m-data (x-concat model.name "BindingProxy") key="bindingProxyClassName" ~}}

{{{ x-header }}}

{{#with model}}
namespace {{ @root.host.namespace }}
{
	using System;
	using System.Linq;
	using System.Resources;
	using System.Globalization;
	using System.Threading;

	[System.Diagnostics.DebuggerNonUserCodeAttribute()]
	[System.Runtime.CompilerServices.CompilerGeneratedAttribute()]
	public partial class {{@root.data.rootClassName}}: {{@root.data.bindableObjectFullName}}, IFormattable
	{
		private CultureInfo _culture;
		{{#if @root.settings.MissingTranslationFallbackToPrimary }}
		private CultureInfo _fallbackCulture;
		{{else}}
	
		{{/if}}
		private static readonly Lazy<{{@root.data.rootClassName}}> _instance = new Lazy<{{@root.data.rootClassName}}>(() => new {{@root.data.rootClassName}}());
		private static readonly Lazy<ResourceManager> _resourceManager = new Lazy<ResourceManager>(CreateResourceManager);

		private {{@root.data.rootClassName}}()
		{}

		{{#if @root.settings.UseExpressionBodySyntax }}
		public static ResourceManager ResourceManager => _resourceManager.Value;
		{{else}}
		public static ResourceManager ResourceManager
		{
			get
			{
				return _resourceManager.Value;
			}
		}
		{{/if}}

		public const string PrimaryCulture = "{{primaryLanguage}}";

		{{#if @root.settings.UseExpressionBodySyntax }}
		public string[] AvailableCultures => new string[] { {{{x-join languages decorator=(char-quote) }}} };
		{{else}}
		public string[] AvailableCultures
		{
			get
			{
				return new string[] { {{{x-join languages decorator=(char-quote) }}} };
			}
		}
		{{/if}}

		{{#if @root.settings.MissingTranslationFallbackToPrimary }}
		public CultureInfo FallbackCulture
		{
			get
			{
				if (_fallbackCulture == null)
				{
					_fallbackCulture = new CultureInfo(PrimaryCulture);
				}
				return _fallbackCulture;
			}
			set
			{
				if ((value == null) || !AvailableCultures.Contains(value.Name))
				{
					throw new InvalidOperationException($"Unable to set fallback culture to '{value.Name}' which is not defined in available cultures!");
				}

				_fallbackCulture = value;
			}
		}
		{{/if}}

		public static {{@root.data.rootClassName}} Instance
		{
			get
			{
				return _instance.Value;
			}
		}

		public CultureInfo Culture
		{
			get
			{
				return _culture ?? (_culture = CultureInfo.CurrentUICulture);
			}
			set
			{
				if (value == null)
				{
					throw new ArgumentNullException("Culture must not be null");
				}

				if (value.Name == Culture.Name)
				{
					return;
				}

				_culture = value;
				Thread.CurrentThread.CurrentUICulture = _culture;
				OnPropertyChanged(nameof(Culture));

				{{@root.data.bindingProxyClassName}}.Instance.RefreshProperties();
			}
		}

		private static ResourceManager CreateResourceManager()
		{
			return new ResourceManager("{{@root.data.resourceTypeName}}",
				typeof({{@root.data.resourceType}}).Assembly);
		}

		public string ToString(string format, IFormatProvider formatProvider)
		{
			return GetStringSafely(format);
		}

		public string GetStringSafely(string name)
		{
			if (name == null)
			{
				throw new ArgumentNullException(nameof(name));
			}

			string result = GetStringSafely(name, Culture);
			if (result == null)
			{
				{{#if @root.settings.MissingTranslationFallbackToPrimary }}
				if (FallbackCulture != null)
				{
					result = GetStringSafely(name, FallbackCulture);
					if (result == null)
					{
						result = string.Format("???{0}.{1}???", name, FallbackCulture == null ? string.Empty : FallbackCulture.Name);
					}
				}
				{{else}}
				result = string.Format("???{0}.{1}???", name, Culture == null ? string.Empty : Culture.Name);
				{{/if}}
			}

			return result;
		}

		private string GetStringSafely(string name, CultureInfo culture)
		{
			string result = null;
			try
			{
				result = culture == null ? ResourceManager.GetString(name) : ResourceManager.GetString(name, culture);
			}
			catch (MissingManifestResourceException)
			{
				// Resource does not exist
			}

			return result;
		}
	}

	[System.Diagnostics.DebuggerNonUserCodeAttribute()]
	[System.Runtime.CompilerServices.CompilerGeneratedAttribute()]
	public static partial class {{@root.data.keysClassName}}
	{
	{{#each categories ~}}
		{{~#x-merge _resourceRenderValue="key" ~}}
		{{> category }}
		{{~/x-merge~}}
	{{#if (x-equals @last false) }}     
		
	{{/if}}
	{{/each}}
	{{#if resources}}
		
	{{#x-merge _resourceRenderValue="key" ~}}
	{{> resources }}
	{{~/x-merge~}}
    {{/if}}
	}

	[System.Diagnostics.DebuggerNonUserCodeAttribute()]
	[System.Runtime.CompilerServices.CompilerGeneratedAttribute()]
	public partial class {{name}}
	{
	{{#each categories ~}}
		{{~#x-merge _resourceRenderValue="value" ~}}
		{{> category }}
		{{~/x-merge~}}
	{{#if (x-equals @last false) }}
		
	{{/if}}
	{{/each}}
	{{#if resources}}
		
	{{#x-merge _resourceRenderValue="value" ~}}
	{{> resources }}
	{{~/x-merge~}}
    {{/if}}
	}

	[System.Diagnostics.DebuggerNonUserCodeAttribute()]
	[System.Runtime.CompilerServices.CompilerGeneratedAttribute()]
	public partial class {{@root.data.bindingProxyClassName}}: {{@root.data.bindableObjectFullName}}
	{
		private {{@root.data.bindingProxyClassName}}() 
		{}

		public static {{@root.data.bindingProxyClassName}} Instance { get; } = new {{@root.data.bindingProxyClassName}}();

	{{> categoriesproxy}}

		
		{{#if resources}}
		{{#x-merge _static=true ~}}
		{{> resourcesproxy }}
		{{~/x-merge~}}
		{{/if}}
	}
}
{{/with}}
{{#*inline "category"}}
public{{x-render " static" when=(x-equals _resourceRenderValue "key") }} partial class {{name}}
{
{{#each categories }}
	{{~#x-merge _resourceRenderValue=../_resourceRenderValue ~}}
	{{> category }}
	{{~/x-merge~}}
{{#if (x-equals @last false) }}
	
{{/if}}
{{/each}}
{{> resources }}
}
{{/inline}}
{{#*inline "resources"}}
{{#if resources}}
{{#each resources}}
	{{m-data (x-fn paths.getParentPath '') key="parentPath" ~}}
	{{m-data (x-concat @root.data.keysClassName (x-fn paths.getParentPath '.') sep=".") key="resourceFullPath" ~}}
	{{m-data (x-concat name @root.settings.ParamsMethodsSuffix sep="") key="nameWithMethodsSuffix" ~}}
	/// <summary>
	/// Gets localized string similar to: {{{ this.comment }}}
	/// </summary>
	{{#if (x-equals ../_resourceRenderValue "key") }}
	public const string {{name}} = "{{data.parentPath}}";
	{{else}}
	{{#if @root.settings.UseExpressionBodySyntax }}
	public static string {{name}} => {{@root.data.rootClassName}}.Instance.GetStringSafely({{data.resourceFullPath}});
	{{else}}
	public static string {{name}}
	{
		get
		{
			return {{@root.data.rootClassName}}.Instance.GetStringSafely({{data.resourceFullPath}});
		}
	}
	{{/if}}
	{{#if (x-logical hasParameters @root.settings.GenerateParamsMethods op="and") }}
	{{~m-data query="join(',', map(&join('', ['object ', @.name]), parameters))" key="resourceParamNamesWithTypes" ~}}
	{{~m-data query="join(',', map(&@.name, parameters))" key="resourceParamNames" ~}}
¤
	/// <summary>
	/// Gets localized string similar to: {{{ this.comment }}}
	/// </summary>
	{{#if @root.settings.UseExpressionBodySyntax }}
	public static string {{data.nameWithMethodsSuffix}}({{ data.resourceParamNamesWithTypes }}) => string.Format({{@root.data.rootClassName}}.Instance.GetStringSafely({{data.resourceFullPath}}), {{ data.resourceParamNames }});
	{{else}}
	public static string {{data.nameWithMethodsSuffix}}({{ data.resourceParamNamesWithTypes }})
	{
		return string.Format({{@root.data.rootClassName}}.Instance.GetStringSafely({{data.resourceFullPath}}), {{ data.resourceParamNames }});
	}
	{{/if}}
	{{/if}}
¤
	{{/if}}
{{/each}}
{{/if}}
{{/inline}}
{{#*inline "categoriesproxy"}}
{{#each categories }}
{{#if hasCategories }}
	{{> categoriesproxy }}
{{/if}}
	{{> resourcesproxy }}
¤
{{/each}}
{{/inline}}
{{#*inline "resourcesproxy"}}
{{#if resources}}
{{#each resources}}
{{m-data (x-fn paths.getParentPath '') key="parentPath" ~}}
{{~m-data (x-concat name @root.settings.ParamsMethodsSuffix sep="") key="nameWithMethodsSuffix" ~}}
{{m-data (x-concat @root.data.keysClassName (x-fn paths.getParentPath '.') sep=".") key="resourceFullPath" ~}}

/// <summary>
/// Gets localized string similar to: {{{ this.comment }}}
/// </summary>
{{#if (x-isTrue ../_static)}}
public static string {{name}}
{
	get
	{
		return {{@root.data.rootClassName}}.Instance.GetStringSafely({{@root.data.keysClassName}}.{{name}});
	}
}
{{else}}
public string {{data.parentPath}}
{
	get
	{
		return {{@root.data.rootClassName}}.Instance.GetStringSafely({{data.resourceFullPath}});
	}
}
{{/if}}
{{#if (x-logical hasParameters @root.settings.GenerateParamsMethods op="and") }}
{{~m-data query="join(',', map(&join('', ['object ', @.name]), parameters))" key="resourceParamNamesWithTypes" ~}}
{{~m-data query="join(',', map(&@.name, parameters))" key="resourceParamNames" ~}}
¤
/// <summary>
/// Gets localized string similar to: {{{ this.comment }}}
/// </summary>
{{#if @root.settings.UseExpressionBodySyntax }}
public static string {{data.nameWithMethodsSuffix}}({{ data.resourceParamNamesWithTypes }}) => string.Format({{@root.data.rootClassName}}.Instance.GetStringSafely({{data.resourceFullPath}}), {{ data.resourceParamNames }});
{{else}}
public static string {{data.nameWithMethodsSuffix}}({{ data.resourceParamNamesWithTypes }})
{
	return string.Format({{@root.data.rootClassName}}.Instance.GetStringSafely({{data.resourceFullPath}}), {{ data.resourceParamNames }});
}
{{/if}}
{{/if}}
{{/each}}
{{/if}}
{{/inline}}